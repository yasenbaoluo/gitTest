create or replace trigger TRG_F_SHOZAIKO_BAT_HIST
AFTER INSERT OR UPDATE ON F_SHOZAIKO
 FOR EACH ROW
 BEGIN
    INSERT INTO F_SHOZAIKO_BAT_HIST (
        HIST_SEQ,
        HINBAN,
        COLORCD,
        SIZECD,
        RYOZAIKOSU_INCRE,
        BADZAIKOSU_INCRE,
        ATEKANOSU_INCRE,
        ATESUMISU_INCRE,
        ATEHOKASU_INCRE,
        KARIATEKANOSU_INCRE,
        KARIATESUMISU_INCRE,
        HACZANSU_INCRE,
        JUCHUZANSU_INCRE,
        HACATESUMISU_INCRE,
        RJUCHUSU_INCRE,
        RNOGASHISU_INCRE,
        RJUCCANSU_INCRE,
        RYOZAIKOSU_OLD,
        BADZAIKOSU_OLD,
        ATEKANOSU_OLD,
        ATESUMISU_OLD,
        ATEHOKASU_OLD,
        KARIATEKANOSU_OLD,
        KARIATESUMISU_OLD,
        HACZANSU_OLD,
        JUCHUZANSU_OLD,
        HACATESUMISU_OLD,
        RJUCHUSU_OLD,
        RNOGASHISU_OLD,
        RJUCCANSU_OLD,
        BAT_OPT_STATUS,
        BIZ_DATE,
        CRT_DT,
        CRT_DT_ROUND,
        UPD_DT_OLD)
    SELECT
    SEQ_HISTNO.NEXTVAL,
    :NEW.HINBAN,
    :NEW.COLORCD,
    :NEW.SIZECD,
    NVL(:NEW.RYOZAIKOSU, 0) - NVL(:OLD.RYOZAIKOSU, 0),
    NVL(:NEW.BADZAIKOSU, 0) - NVL(:OLD.BADZAIKOSU, 0),
    NVL(:NEW.ATEKANOSU, 0) - NVL(:OLD.ATEKANOSU, 0),
    NVL(:NEW.ATESUMISU, 0) - NVL(:OLD.ATESUMISU, 0),
    NVL(:NEW.ATEHOKASU, 0) - NVL(:OLD.ATEHOKASU, 0),
    NVL(:NEW.KARIATEKANOSU, 0) - NVL(:OLD.KARIATEKANOSU, 0),
    NVL(:NEW.KARIATESUMISU, 0) - NVL(:OLD.KARIATESUMISU, 0),
    NVL(:NEW.HACZANSU, 0) - NVL(:OLD.HACZANSU, 0),
    NVL(:NEW.JUCHUZANSU, 0) - NVL(:OLD.JUCHUZANSU, 0),
    NVL(:NEW.HACATESUMISU, 0) - NVL(:OLD.HACATESUMISU, 0),
    NVL(:NEW.RJUCHUSU, 0) - NVL(:OLD.RJUCHUSU, 0),
    NVL(:NEW.RNOGASHISU, 0) - NVL(:OLD.RNOGASHISU, 0),
    NVL(:NEW.RJUCCANSU, 0) - NVL(:OLD.RJUCCANSU, 0),
    NVL(:OLD.RYOZAIKOSU, 0),
    NVL(:OLD.BADZAIKOSU, 0),
    NVL(:OLD.ATEKANOSU, 0),
    NVL(:OLD.ATESUMISU, 0),
    NVL(:OLD.ATEHOKASU, 0),
    NVL(:OLD.KARIATEKANOSU, 0),
    NVL(:OLD.KARIATESUMISU, 0),
    NVL(:OLD.HACZANSU, 0),
    NVL(:OLD.JUCHUZANSU, 0),
    NVL(:OLD.HACATESUMISU, 0),
    NVL(:OLD.RJUCHUSU, 0),
    NVL(:OLD.RNOGASHISU, 0),
    NVL(:OLD.RJUCCANSU, 0),
    0,
    M_CONTROL.CNTRLNUM1,
    SYSDATE,
    CASE WHEN TO_CHAR(SYSDATE, 'YYYYMMDD') > NVL(M_CONTROL.CNTRLNUM1, '99991231')
            THEN NVL(M_CONTROL.CNTRLNUM1, '99991231') || TO_CHAR(SYSDATE, 'HH24')+24 || TRUNC(TO_CHAR(SYSDATE, 'MI')/10, 0)*10
         WHEN TO_CHAR(SYSDATE, 'YYYYMMDD') <= NVL(M_CONTROL.CNTRLNUM1, '99991231')
            THEN TO_CHAR(SYSDATE, 'YYYYMMDDHH24')|| TRUNC(TO_CHAR(SYSDATE, 'MI')/10, 0)*10
    END AS CRT_DT_ROUND,
    :OLD.UPD_DT
    FROM M_CONTROL
    WHERE
    CNTRLKBN = 1 AND CNTRLKEY = 1;
EXCEPTION
 WHEN OTHERS THEN
  NULL;
END;